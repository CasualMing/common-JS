<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Document</title>
</head>

<body>
	<script>
		// 回到顶部
		function backTop() {
			let timer = null;
			cancelAnimationFrame(timer);
			timer = requestAnimationFrame(function fn() {
				var oTop = document.body.scrollTop || document.documentElement.scrollTop;
				if (oTop > 0) {
					document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
					timer = requestAnimationFrame(fn);
				} else {
					cancelAnimationFrame(timer);
				}
			});
		};

		// 判断滚动
		window.onscroll = function () {
			let top = document.body.scrollTop || document.documentElement.scrollTop
			if (top >= distanceTopHeight) {
				$(".navigate")[0].style.cssText = "position:fixed;left:50%;transform: translateX(-50%);top:0px";
			} else {
				$(".navigate")[0].style.cssText = "position:relative";
			}
		};
		// 滚动到指定位置  number:距离顶部的位置。time:滚动的时间
		const ScrollTop = (number = 0, time) => {
			if (!time) {
				document.body.scrollTop = document.documentElement.scrollTop = number;
				return number;
			}
			const spacingTime = 20; // 设置循环的间隔时间  值越小消耗性能越高
			let spacingInex = time / spacingTime; // 计算循环的次数
			let nowTop = document.body.scrollTop + document.documentElement.scrollTop; // 获取当前滚动条位置
			let everTop = (number - nowTop) / spacingInex; // 计算每次滑动的距离
			let scrollTimer = setInterval(() => {
				if (spacingInex > 0) {
					spacingInex--;
					ScrollTop(nowTop += everTop);
				} else {
					clearInterval(scrollTimer); // 清除计时器
				}
			}, spacingTime);
		};



		//领券 加class：ztcoupon
		$(function () {
			// 非编辑模式下可领券
			if (location.href.indexOf("static_edit") === -1) {
				// 领取现金券
				$(".ztcoupon,.quan a").click(function (e) {
					e.preventDefault();

					var industryId = $(this).attr("href");
					var getTicketUrl = "";
					var datas = {};

					// 判断是否是家装行业，以后有其他行业需要做新的处理，可以在这个地方做判断
					// couponActivityShowType  可控现金券类型0（日常）、1（展会）、2（定义活动）、不填为默认
					if (window.location.href.indexOf('jzmall') != -1) { // 这个是家装行业
						getTicketUrl = "//open.jiehun.com.cn/user/coupon/post-jbs-coupon";
						datas = {
							marketingCouponId: industryId,
							'couponActivityShowType': 0
						}
					} else { // 这个是非家装行业
						getTicketUrl = "//open.jiehun.com.cn/user/coupon/store/post-coupon";
						datas = {
							storeId: industryId,
							'couponActivityShowType': 1
						}
					}

					// 从cookie拿token
					var token = getCookie("Authorization") ? getCookie("Authorization") : getCookie("jhu");
					var cityId = getCityId();
					if (!token) {
						toLoginPage();
					} else {
						// token若无'dmp '则加上
						!token.match(/^dmp\s/) && (token = "dmp " + token);
						var config = {
							url: getTicketUrl,
							data: JSON.stringify(datas),
							type: "POST",
							// dataType:"json",
							success: function (data) {
								var code = data.code;
								var msg = data.message;
								var data = data.data;
								switch (code) {
									case 0:
										msg = data;
										break;
										// 用户未登录
									case 10017:
										toLoginPage();
										break;
									default:
										break;
								}
								hapj.ui.dialog.ok(msg);
							},
							error: function (data) {
								hapj.ui.dialog.error('网络不给力，请稍后再试...');
							},
							complete: function () {
								$(".dialog span.ok").attr("style", "font-size:16px;");
							},
							headers: {
								'content-type': 'application/json;charset=UTF-8',
								'Authorization': token,
								'city-id': cityId
							}
						};
						$.ajax(config);
					}
				})
			}
		});

		var url = window.location.href;
		// 判断城市
		function getCityId() {
			var cityName = location.hostname.match(/([a-z]+)\.jiehun\.com\.cn/i)[1].toLowerCase();
			switch (cityName) {
				case 'bj':
					return "110900";
				case 'sh':
					return "310900";
				case 'gz':
					return "440100";
				case 'tj':
					return "120300";
				case 'wh':
					return "420100";
				case 'hz':
					return "330100";
				case 'chengdu':
					return "510100";
			}
		}
		// 跳转到登录页
		function toLoginPage() {
			if (hapj.browser.ciwApp) {
				// app登录页
				// alert("app登录")
				callApp("loginApp", {}, "loginCallback")
			} else {
				// wap登录页
				// alert("wap登录")
				location.href = "https://m.jiehun.com.cn/login/"
			}
		}
		// 读取cookie
		function getCookie(name) {
			var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
			arr = document.cookie.match(reg);
			if (arr) {
				return unescape(arr[2]);
			} else {
				return null;
			}
		}
		// 唤起app登录
		function callApp(handlerName, args, callbackName) {
			callbackName = !!callbackName ? callbackName : '';
			args = JSON.stringify(args) ? JSON.stringify(args) : '';

			var browser = browers();

			if (browser.isApp) {
				if (browser.ios) {
					window.webkit.messageHandlers.ios.postMessage({
						"handler": handlerName,
						"args": args,
						"callback": callbackName
					});
				}

				if (browser.android) {
					hapj_hybrid.android(handlerName, args, callbackName);
				}
			}
		}
		// 判断环境
		function browers() {
			var ua = navigator.userAgent.toLowerCase();
			// 通过userAgent获取中间的键值对，其中值支持小数点，如v=1.2.2
			var extraMs, extra = {};
			if ((extraMs = /<<([a-z0-9]+\=\w*(?:&[a-z0-9]+\=[\w\.]*)*)>>/.exec(ua.replace('$s=', '&s=')))) {
				var arr = extraMs[1].split('&')
				for (var i in arr) {
					var ar = arr[i].split('=');
					extra[ar[0]] = ar[1];
				}
			}
			var isApp = Object.keys(extra).length;
			return {
				android: ua.indexOf('android') > -1,
				ios: /(ipad|ios|iphone)/.test(ua),
				isApp: isApp
			}
		}
		// 登录回调
		function loginCallback() {
			location.href = url;
		}


		window.onload = function () {
			/**
			 *  @param 参数说明
			 * isAll(true/false):为true代表对整个盒子内所有的区域进行匹配，默认为false,
			 * tabColumn:这个是加给tab栏切换的。加给最外层盒子
			 * priceName:加上这个class,代表对价格进行匹配。只能加到具体的数字上
			 * titleName:加上这个class,代表对商家标题进行匹配
			 * merchantItem：这个是给所有要检索的区块class,元素必须是需要检索的部分，不能包含其他的区块;
			 * pushDistrict:加上这个class，是告诉搜索匹配的元素放在那块区域
			 * boxList:如果tab切换的子元素是上中下结构的，那么每一个tab切块请加上这个class
			 * searchBox:这个是加给搜索框的
			 * submitBox:这个是加给按钮的
			 * maxPriceSeach:加上这个class,代表对对可接受的最大价格进行匹配。只显示低于该价格的,加给输入框的
			 * minPriceSeach:加上这个class,代表对可接受的最小价格进行匹配，只显示低于改价格的，加给输入框的
			 * resultTitle:如果需要显示最后的标题。可以加上这个class
			 * listDom:匹配的区域
			 * domlist:具体匹配的内容
			 * valueText：input用户输入的内容，不区分大小写
			 * arr：暂存数据
			 */
			// 获取元素
			function getDom(dom) {
				if (typeof dom != "string") {
					return console.log("传入的dom类型有误")
				}
				return document.querySelector(dom)
			}

			function getAllDom(dom) {
				if (typeof dom != "string") {
					return console.log("传入的dom类型有误")
				}
				return document.querySelectorAll(dom)
			}

			function getClassDom(dom) {
				if (typeof dom != "string") {
					return console.log("传入的dom类型有误")
				}
				return document.getElementsByClassName(dom);
			}
			// 移除所有的错误提示
			function removeAllError() {
				if (getAllDom(".result-text")) {
					for (let index = 0; index < getAllDom(".result-text").length; index++) {
						const element = getAllDom(".result-text")[index];
						element.parentNode.removeChild(element)
					}
				};
				if (getAllDom(".result-headline")) {
					for (let index = 0; index < getAllDom(".result-headline").length; index++) {
						const element = getAllDom(".result-headline")[index];
						element.parentNode.removeChild(element)
					}
				}
			};
			// 若查找无结果
			function noResult(listDom) {
				removeAllError();
				isTab()
				let p = document.createElement("p");
				p.classList.add("result-text");
				p.innerText = "暂无你要查找的内容";
				listDom[0].parentNode.insertBefore(p, listDom[0])
				for (let index = 0; index < listDom.length; index++) {
					const element = listDom[index];
					element.style.display = "none";
				}
			};
			// 循环对数据进行匹配
			function dataListMatch(listDom, domList, value, arr) {
				for (let index = 0; index < domList.length; index++) {
					const element = domList[index].innerText.toLowerCase();
					let lowText = value.toLowerCase()
					if (element.indexOf(lowText) != -1) {
						arr.push(listDom[index])
					}
				};
			};
			// 如果有tab栏，搜索之后影藏tab栏
			function isTab() {
				if (getAllDom(".tabColumn").length > 0) {
					for (let index = 0; index < getAllDom(".tabColumn").length; index++) {
						const element = getAllDom(".tabColumn")[index];
						element.style.display = "none";
					}
				}
			};
			//  对应的元素显示与隐藏
			function statusOperate(listDom, arr) {
				// 销毁之前克隆到页面上的元素。
				clearClone()
				if (getAllDom(".tabColumn").length) {
					if (getDom(".tabColumn").style.display != "none") {
						isTab();
					}
					for (let index = 0; index < listDom.length; index++) {
						const element = listDom[index];
						element.style.display = "none";
					}
					for (let index = 0; index < arr.length; index++) {
						const element = arr[index];
						let cloneAfter = element.cloneNode(true);
						cloneAfter.classList.add("cloneItem");
						if (getAllDom(".pushDistrict").length) {
							getAllDom(".pushDistrict")[0].style.display = "block";
							getAllDom(".pushDistrict")[0].appendChild(cloneAfter);
						} else {
							return console.log("请给结果留给位置");
						}

					};
					for (let index = 0; index < getAllDom(".cloneItem").length; index++) {
						const element = getAllDom(".cloneItem")[index];
						element.style.display = "block";
					}

				} else {
					for (let index = 0; index < listDom.length; index++) {
						const element = listDom[index];
						element.style.display = "none";
					}
					for (let index = 0; index < arr.length; index++) {
						const element = arr[index];
						let cloneAfter = element.cloneNode(true);
						cloneAfter.classList.add("cloneItem");
						if (getAllDom(".pushDistrict").length) {
							getAllDom(".pushDistrict")[0].style.display = "block";
							getAllDom(".pushDistrict")[0].appendChild(cloneAfter);
						} else {
							return console.log("请给结果留给位置");
						}
						cloneAfter.style.display = "block";
					}
					isTab()
				}
			};
			// 清除克隆元素
			function clearClone() {
				let arr = getAllDom(".cloneItem")
				if (arr.length) {
					for (let index = 0; index < arr.length; index++) {
						const element = arr[index];
						element.style.display = "block";
						element.parentNode.removeChild(element);
					}
				};
			}
			// 价格匹配
			function priceMatch(listDom, priceDom, arr, condition) {
				let valueText = null;
				let maxPrice = null;
				let minPrice = null;
				clearClone()
				if (condition < 2) {
					valueText = parseInt(getDom(".searchBox").value.trim());
				} else {
					maxPrice = parseInt(getDom(".maxPriceSeach").value.trim());
					minPrice = parseInt(getDom(".minPriceSeach").value.trim())
				}
				if (!valueText) {
					window.location.reload();
					return console.log("请输入查找内容");
				};
				if (condition === 0) {
					for (let index = 0; index < priceDom.length; index++) {
						const element = priceDom[index];
						var tempNum = parseInt(element.innerText.trim());
						if (valueText >= tempNum) {
							arr.push(listDom[index])
						}
					}
				} else if (condition === 1) {
					for (let index = 0; index < priceDom.length; index++) {
						const element = priceDom[index];
						var tempNum = parseInt(element.innerText.trim());
						if (valueText <= tempNum) {
							arr.push(listDom[index])
						}
					}
				} else if (condition === 2) {
					for (let index = 0; index < priceDom.length; index++) {
						const element = priceDom[index];
						var tempNum = parseInt(element.innerText.trim());
						if (tempNum >= minPrice || tempNum <= maxPrice) {
							arr.push(listDom[index])
						}
					}
				}
			}
			// 显示最后的标题
			function showTitle() {
				let resultTitle = getDom(".resultTitle");
				if (resultTitle) {
					for (var i = 0; i < resultTitle.children.length; i++) {
						let temp = resultTitle.children[i];
						temp.style.display = "none";
					}
					let p = document.createElement("p");
					p.classList.add("result-headline");
					p.innerText = "查找结果";
					resultTitle.appendChild(p);
				}
			}
			// 
			function isThreePoints() {
				let boxList = null;
				if (getDom(".boxList")) {
					boxList = getDom(".boxList");
				};
				for (var i = 0; i < boxList.children.length; i++) {
					const temp = boxList.children[i];
					temp.style.display = "none";
				}
				boxList.children[0].style.display = "block";
			}


			// 总处理函数
			function searchInt(isAll = false) {
				removeAllError()
				// 获取元素
				let listDom = getAllDom(".merchantItem");
				let priceDom = [];
				let titleDom = [];
				clearClone();
				if (getAllDom(".merchantItem .priceName")) {
					clearClone();
					for (let index = 0; index < getAllDom(".merchantItem .priceName").length; index++) {
						const element = getAllDom(".merchantItem .priceName")[index];
						if (!element.classList.contains("cloneItem")) {
							element.index = index;
							priceDom.push(element)
						}
					}
				};
				if (getAllDom(".merchantItem .titleName")) {
					clearClone();
					for (let index = 0; index < getAllDom(".merchantItem .titleName").length; index++) {
						const element = getAllDom(".merchantItem .titleName")[index];
						if (!element.classList.contains("cloneItem")) {
							element.index = index;
							titleDom.push(element)
						}
					}
				};
				if (isAll) {
					let arr = null;
					let valueText = getDom(".searchBox").value;
					dataListMatch(listDom, listDom, valueText, arr);
					statusOperate(listDom, arr);
				} else {
					clearClone();
					if (!listDom.length) {
						return console.log("请保证对应父级搜索匹配class名正确");
					} else {
						if (!priceDom.length && !titleDom.length) {
							return console.log("请保证页面内有搜索条件class")
						} else if (priceDom.length && !titleDom.length) {
							let arr = [];
							if (!getDom(".searchBox")) {
								return console.log("请给搜索框正确的class")
							} else if (getAllDom(".maxPriceSeach").length && !getAllDom(".minPriceSeach").length) {
								priceMatch(listDom, priceDom, arr, 0);
							} else if (!getAllDom(".maxPriceSeach").length && getAllDom(".minPriceSeach").length) {
								priceMatch(listDom, priceDom, arr, 1);
							} else if (getAllDom(".maxPriceSeach").length && getAllDom(".minPriceSeach").length) {
								priceMatch(listDom, priceDom, arr, 2);
							} else {
								let valueText = getDom(".searchBox").value;
								if (!valueText) {
									return console.log("请输入查找内容")
								}
								dataListMatch(listDom, priceDom, valueText, arr);
							}

							if (arr.length < 1) {
								noResult(listDom)
							} else {
								statusOperate(listDom, arr);
								arr = []
							}

						} else if (titleDom.length && !priceDom.length) {
							let arr = [];
							if (!getDom(".searchBox")) {
								return console.log("请给搜索框正确的class")
							}
							let valueText = getDom(".searchBox").value
							if (!valueText) {
								noResult(listDom)
								return console.log("请输入查找内容")
							}
							dataListMatch(listDom, titleDom, valueText, arr)
							if (arr.length < 1) {
								noResult(listDom);
							} else {
								statusOperate(listDom, arr);
							}
						} else {
							return console.log("给任意一个搜索条件class")
						}
					}
				}
				priceDom = [];
				titleDom = [];
				showTitle();
				isThreePoints();
			};
			// 默认监听
			// 监听回车键
			document.onkeydown = function (event) {
				var e = event || window.event || arguments.callee.caller.arguments[0];
				if (e && e.keyCode == 13) {
					searchInt();
				}
			};
			// 监听submit提交
			if (getDom(".submitBox") && getDom(".submitBox").type === "submit") {
				getDom(".submitBox").onsubmit = function () {
					searchInt()
				}
			}
			// 监听点击事件
			if (!getDom(".submitBox")) {
				return console.log("请给搜索按钮一个正确的class")
			}
			getDom(".submitBox").onclick = function () {
				searchInt()
			}
		}
	</script>
</body>

</html>